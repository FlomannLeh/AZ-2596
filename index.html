<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Einlasskriterien Baukasten</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f3f3;
        }
        .logical-separator {
            font-weight: 500;
            color: #4b5563;
            text-align: center;
            margin: 0.75rem 0;
        }
        select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url('data:image/svg+xml;charset=UTF-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="none" stroke="%236b7280" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 9l4 4 4-4"/></svg>');
            background-repeat: no-repeat;
            background-position: right 0.5rem center;
            background-size: 1.25em;
            padding-right: 2.5rem;
        }
        .condition-row-wrapper {
            border-left-width: 4px;
            background-color: #fafafa; /* Hellgrauer Hintergrund für die Filter-Karte */
        }
        .filter-include {
            border-left-color: #22c55e; /* green-500 */
        }
        .filter-exclude {
            border-left-color: #ef4444; /* red-500 */
        }
        .filter-neutral {
             border-left-color: #e5e7eb; /* gray-200 */
        }

        /* --- Multiselect Component Styles --- */
        .multiselect-container {
            position: relative;
            flex-grow: 1;
        }
        .multiselect-input-wrapper {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 0.5rem;
            padding: 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            background-color: white;
            cursor: text;
            min-height: 44px;
        }
        .multiselect-tag {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            background-color: #e5e7eb;
            color: #374151;
            padding: 0.125rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.875rem;
        }
        .multiselect-tag-remove {
            cursor: pointer;
            font-weight: bold;
        }
        .multiselect-search-input {
            border: none;
            outline: none;
            flex-grow: 1;
        }
        .multiselect-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background-color: white;
            border: 1px solid #d1d5db;
            border-top: none;
            border-radius: 0 0 0.375rem 0.375rem;
            max-height: 200px;
            overflow-y: auto;
            z-index: 10;
        }
        .multiselect-option {
            padding: 0.5rem 0.75rem;
            cursor: pointer;
        }
        .multiselect-option:hover {
            background-color: #f3f4f6;
        }
         .multiselect-option-info {
            padding: 0.5rem 0.75rem;
            font-style: italic;
            color: #6b7280;
        }
    </style>
</head>
<body class="p-8">

    <div class="max-w-4xl mx-auto">
        <div class="bg-white p-6 md:p-8 rounded-lg border border-gray-200 shadow-sm">
            <div class="p-4 rounded-lg mb-6 border border-gray-200" style="background-color: #fafafa;">
                <h1 class="text-2xl font-semibold mb-2">Einlasskriterien</h1>
                <p class="text-gray-600">Bei Verwendung von Ticketfiltern wird ein Ticket erfolgreich gescannt, wenn es mindestens eines der folgenden Filterkriterien erfüllt:</p>
            </div>

            <div id="filter-editor-container" class="space-y-3">
                <!-- Filter criteria will be added here -->
            </div>
            
            <div class="mt-4">
                 <button id="add-criterion-btn" class="w-full bg-gray-900 text-white font-semibold py-3 px-4 rounded-lg hover:bg-gray-800 transition-colors flex items-center justify-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-plus-lg" viewBox="0 0 16 16">
                      <path fill-rule="evenodd" d="M8 2a.5.5 0 0 1 .5.5v5h5a.5.5 0 0 1 0 1h-5v5a.5.5 0 0 1-1 0v-5h-5a.5.5 0 0 1 0-1h5v-5A.5.5 0 0 1 8 2"/>
                    </svg>
                    Neues Einlasskriterium hinzufügen
                </button>
            </div>
        </div>
        <div class="mt-4 flex justify-end items-center gap-3">
             <button class="text-gray-700 font-semibold py-2 px-4 rounded-lg hover:bg-gray-100 transition-colors">
                Abbrechen
            </button>
             <button class="bg-gray-900 text-white font-semibold py-2 px-4 rounded-lg hover:bg-gray-800 transition-colors">
                Speichern
            </button>
        </div>
    </div>


    <template id="condition-template">
         <div class="condition-row-wrapper relative border border-gray-300 rounded-lg p-3 filter-neutral">
            <div class="flex items-center gap-3">
                <select class="filter-type bg-white border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 py-2.5 px-4 min-w-[150px]">
                    <option value="kategorie">Kategorie</option>
                    <option value="preisstufe">Preisstufe</option>
                    <option value="block">Block</option>
                    <option value="merkmal">Merkmal</option>
                    <option value="saalplanLabel">Saalplan-Label</option>
                </select>
                <select class="filter-operator bg-white border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 py-2.5 px-4 min-w-[180px]">
                    <option value="is">ist eine von</option>
                    <option value="isNot">ist keine von</option>
                </select>
                <div class="multiselect-container">
                    <div class="multiselect-input-wrapper">
                        <input type="text" class="multiselect-search-input" placeholder="Werte auswählen...">
                    </div>
                    <div class="multiselect-dropdown hidden"></div>
                </div>
                 <button class="delete-condition-btn p-1 rounded-full text-gray-500 hover:bg-gray-200 hover:text-gray-800 transition-colors">
                     <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708"/>
                    </svg>
                </button>
            </div>
        </div>
    </template>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- DATA ---
    const filterOptionsData = {
        kategorie: ["Kategorie 1", "Kategorie 2", "Kategorie 3", "Festivalpass"],
        preisstufe: ["Erwachsene", "Kind", "VIP Gold", "Ermäßigt", "3. Preisstufe", "Begleitperson"],
        block: ["A", "B", "C", "D", "Parkett links", "Parkett rechts", "Balkon Mitte"],
        merkmal: ["Rollstuhlfahrer", "Sichtbehindert", "Presse"],
        saalplanLabel: ["Beste Sicht", "Premium", "Standard"]
    };

    // --- DOM ELEMENTS ---
    const editorContainer = document.getElementById('filter-editor-container');
    const addCriterionBtn = document.getElementById('add-criterion-btn');
    const conditionTemplate = document.getElementById('condition-template');

    // --- CORE FUNCTIONS ---

    function updateAll() {
        updateFilterTypeOptions();
        updateSeparators();
    }
    
    function updateSeparators() {
        const rows = editorContainer.querySelectorAll('.condition-row-wrapper, .logical-separator');
        rows.forEach(el => {
            if (el.classList.contains('logical-separator')) {
                el.remove();
            }
        });

        const newRows = editorContainer.querySelectorAll('.condition-row-wrapper');
        newRows.forEach((row, index) => {
            if (index > 0) {
                 const separator = document.createElement('div');
                 separator.className = 'logical-separator';
                 separator.textContent = 'ODER';
                 row.before(separator);
            }
        });
    }


    function updateFilterTypeOptions() {
        const allTypeSelects = editorContainer.querySelectorAll('.filter-type');
        const usedTypes = new Set();
        const exceptionTypes = ['merkmal', 'saalplanLabel'];

        allTypeSelects.forEach(select => {
            if (!exceptionTypes.includes(select.value)) {
                usedTypes.add(select.value);
            }
        });

        allTypeSelects.forEach(currentSelect => {
            Array.from(currentSelect.options).forEach(option => {
                option.disabled = usedTypes.has(option.value) && currentSelect.value !== option.value;
            });
        });
    }
    
    function handleOperatorStyling(conditionElement) {
        const operatorSelect = conditionElement.querySelector('.filter-operator');
        const typeSelect = conditionElement.querySelector('.filter-type');
        
        const type = typeSelect.value;
        if (type === 'merkmal' || type === 'saalplanLabel') {
            operatorSelect.value = 'is';
            operatorSelect.querySelector('option[value="isNot"]').style.display = 'none';
        } else {
            operatorSelect.querySelector('option[value="isNot"]').style.display = 'block';
        }
        
        const operator = operatorSelect.value;
        conditionElement.classList.remove('filter-include', 'filter-exclude', 'filter-neutral');
        if(operator === 'is') {
            conditionElement.classList.add('filter-include');
        } else if (operator === 'isNot') {
            conditionElement.classList.add('filter-exclude');
        }
    }

    function addFilterRow() {
        const conditionFragment = conditionTemplate.content.cloneNode(true);
        const newConditionElement = conditionFragment.querySelector('.condition-row-wrapper');
        editorContainer.appendChild(newConditionElement);
        
        initializeMultiselect(newConditionElement);
        
        const operatorSelect = newConditionElement.querySelector('.filter-operator');
        operatorSelect.addEventListener('change', () => handleOperatorStyling(newConditionElement));
       
        handleOperatorStyling(newConditionElement);
        updateAll();
    }
    
    function initializeMultiselect(conditionElement) {
        const container = conditionElement.querySelector('.multiselect-container');
        const inputWrapper = container.querySelector('.multiselect-input-wrapper');
        const searchInput = container.querySelector('.multiselect-search-input');
        const dropdown = container.querySelector('.multiselect-dropdown');
        const filterTypeSelect = conditionElement.querySelector('.filter-type');
        
        let selectedValues = new Set();
        let currentFilterType = filterTypeSelect.value;

        function renderDropdown() {
            const availableOptions = filterOptionsData[currentFilterType] || [];
            const searchTerm = searchInput.value.toLowerCase();
            dropdown.innerHTML = '';
            
            const filteredOptions = availableOptions
                .filter(option => !selectedValues.has(option) && option.toLowerCase().includes(searchTerm));

            filteredOptions.forEach(option => {
                const optionEl = document.createElement('div');
                optionEl.className = 'multiselect-option';
                optionEl.textContent = option;
                optionEl.dataset.value = option;
                dropdown.appendChild(optionEl);
            });
            
            if (searchTerm.trim() !== '') {
                 const infoEl = document.createElement('div');
                 infoEl.className = 'multiselect-option-info';
                 infoEl.innerHTML = `Drücke Enter, um "<em>${searchInput.value}</em>" hinzuzufügen`;
                 dropdown.appendChild(infoEl);
            }
        }

        function renderTags() {
            inputWrapper.querySelectorAll('.multiselect-tag').forEach(tag => tag.remove());
            selectedValues.forEach(value => {
                const tagEl = document.createElement('div');
                tagEl.className = 'multiselect-tag';
                tagEl.innerHTML = `<span>${value}</span><span class="multiselect-tag-remove pl-1" data-value="${value}">&times;</span>`;
                inputWrapper.insertBefore(tagEl, searchInput);
            });
        }
        
        function addValue(value) {
             if (value && !selectedValues.has(value)) {
                selectedValues.add(value);
                searchInput.value = '';
                renderTags();
                renderDropdown();
            }
        }

        filterTypeSelect.addEventListener('change', () => {
            currentFilterType = filterTypeSelect.value;
            selectedValues.clear();
            renderTags();
            renderDropdown();
            handleOperatorStyling(conditionElement);
            updateAll();
        });

        inputWrapper.addEventListener('click', () => {
            dropdown.classList.remove('hidden');
            searchInput.focus();
        });

        searchInput.addEventListener('input', renderDropdown);
        
        searchInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && searchInput.value.trim() !== '') {
                e.preventDefault();
                addValue(searchInput.value.trim());
            }
        });
        
        dropdown.addEventListener('click', (e) => {
            if (e.target.classList.contains('multiselect-option')) {
                addValue(e.target.dataset.value);
                searchInput.focus();
            }
        });

        inputWrapper.addEventListener('click', (e) => {
            if (e.target.classList.contains('multiselect-tag-remove')) {
                selectedValues.delete(e.target.dataset.value);
                renderTags();
                renderDropdown();
            }
        });
        
        renderDropdown();
    }
    
    // --- GLOBAL EVENT LISTENERS ---

    document.addEventListener('click', (e) => {
        // Close all multiselect dropdowns if clicked outside
        document.querySelectorAll('.multiselect-container').forEach(container => {
            if (!container.contains(e.target)) {
                container.querySelector('.multiselect-dropdown').classList.add('hidden');
            }
        });
    });

    addCriterionBtn.addEventListener('click', addFilterRow);

    editorContainer.addEventListener('click', (e) => {
        if (e.target.closest('.delete-condition-btn')) {
            const conditionWrapper = e.target.closest('.condition-row-wrapper');
            conditionWrapper.remove();
            updateAll();
        }
    });

    // --- INITIALIZATION ---
    addFilterRow();
});
</script>

</body>
</html>
